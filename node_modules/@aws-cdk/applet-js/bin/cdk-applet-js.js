#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("source-map-support/register");
const cdk = require("@aws-cdk/cdk");
const child_process = require("child_process");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const YAML = require("yaml");
const applet_helpers_1 = require("../lib/applet-helpers");
main().catch(e => {
    // tslint:disable-next-line:no-console
    console.error(e);
    process.exit(1);
});
async function main() {
    const progname = path.basename(process.argv[1]);
    const appletFile = process.argv[2];
    if (!appletFile) {
        throw new Error(`Usage: ${progname} <applet.yaml>`);
    }
    // read applet(s) properties from the provided file
    const fileContents = YAML.parse(await fs.readFile(appletFile, { encoding: 'utf-8' }));
    if (typeof fileContents !== 'object') {
        throw new Error(`${appletFile}: should contain a YAML object`);
    }
    const appletMap = fileContents.applets;
    if (!appletMap) {
        throw new Error(`${appletFile}: must have an 'applets' key`);
    }
    const searchDir = path.dirname(appletFile);
    const tempDir = await fs.mkdtemp(path.join(os.tmpdir(), 'cdkapplet'));
    try {
        const app = new cdk.App();
        for (const [name, definition] of Object.entries(appletMap)) {
            await constructStack(app, searchDir, tempDir, name, definition);
        }
        app.run();
    }
    finally {
        await fs.remove(tempDir);
    }
}
/**
 * Construct a stack from the given props
 * @param props Const
 */
async function constructStack(app, searchDir, tempDir, stackName, spec) {
    // the 'applet' attribute tells us how to load the applet. in the javascript case
    // it will be in the format <module>:<class> where <module> is technically passed to "require"
    // and <class> is expected to be exported from the module.
    const appletSpec = spec.type;
    if (!appletSpec) {
        throw new Error(`Applet ${stackName} missing "type" attribute`);
    }
    const applet = applet_helpers_1.parseApplet(appletSpec);
    const props = spec.properties || {};
    if (applet.npmPackage) {
        // tslint:disable-next-line:no-console
        console.error(`Installing NPM package ${applet.npmPackage}`);
        // Magic marker to download this package directly off of NPM
        // We're going to run NPM as a shell (since programmatic usage is not stable
        // by their own admission) and we're installing into a temporary directory.
        // (Installing into a permanent directory is useless since NPM doesn't do
        // any real caching anyway).
        child_process.execFileSync('npm', ['install', '--prefix', tempDir, '--global', applet.npmPackage], {
            stdio: 'inherit'
        });
        searchDir = path.join(tempDir, 'lib');
    }
    // we need to resolve the module name relatively to where the applet file is
    // and not relative to this module or cwd.
    const modulePath = require.resolve(applet.moduleName, { paths: [searchDir] });
    // load the module
    const pkg = require(modulePath);
    // find the applet class within the package
    // tslint:disable-next-line:variable-name
    const appletConstructor = pkg[applet.className];
    if (!appletConstructor) {
        throw new Error(`Cannot find applet class "${applet.className}" in module "${applet.moduleName}"`);
    }
    if (applet_helpers_1.isStackConstructor(appletConstructor)) {
        // add the applet stack into the app.
        new appletConstructor(app, stackName, props);
    }
    else {
        // Make a stack THEN add it in
        const stack = new cdk.Stack(app, stackName, props);
        new appletConstructor(stack, 'Default', props);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLWFwcGxldC1qcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNkay1hcHBsZXQtanMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsdUNBQXFDO0FBRXJDLG9DQUFxQztBQUNyQywrQ0FBZ0Q7QUFDaEQsK0JBQWdDO0FBQ2hDLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFDOUIsNkJBQThCO0FBRTlCLDBEQUF3RTtBQUV4RSxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7SUFDZixzQ0FBc0M7SUFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDO0FBRUgsS0FBSyxVQUFVLElBQUk7SUFDakIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFaEQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuQyxJQUFJLENBQUMsVUFBVSxFQUFFO1FBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyxVQUFVLFFBQVEsZ0JBQWdCLENBQUMsQ0FBQztLQUNyRDtJQUVELG1EQUFtRDtJQUNuRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3RGLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxFQUFFO1FBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxVQUFVLGdDQUFnQyxDQUFDLENBQUM7S0FDaEU7SUFDRCxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDO0lBQ3ZDLElBQUksQ0FBQyxTQUFTLEVBQUU7UUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsVUFBVSw4QkFBOEIsQ0FBQyxDQUFDO0tBQzlEO0lBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMzQyxNQUFNLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUN0RSxJQUFJO1FBQ0YsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFMUIsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDMUQsTUFBTSxjQUFjLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQ2pFO1FBQ0QsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQ1g7WUFBUztRQUNSLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUMxQjtBQUNILENBQUM7QUFFRDs7O0dBR0c7QUFDSCxLQUFLLFVBQVUsY0FBYyxDQUFDLEdBQVksRUFBRSxTQUFpQixFQUFFLE9BQWUsRUFBRSxTQUFpQixFQUFFLElBQVM7SUFDMUcsaUZBQWlGO0lBQ2pGLDhGQUE4RjtJQUM5RiwwREFBMEQ7SUFDMUQsTUFBTSxVQUFVLEdBQXVCLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDakQsSUFBSSxDQUFDLFVBQVUsRUFBRTtRQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxTQUFTLDJCQUEyQixDQUFDLENBQUM7S0FDakU7SUFFRCxNQUFNLE1BQU0sR0FBRyw0QkFBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRXZDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO0lBRXBDLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRTtRQUNyQixzQ0FBc0M7UUFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDN0QsNERBQTREO1FBQzVELDRFQUE0RTtRQUM1RSwyRUFBMkU7UUFDM0UseUVBQXlFO1FBQ3pFLDRCQUE0QjtRQUM1QixhQUFhLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDakcsS0FBSyxFQUFFLFNBQVM7U0FDakIsQ0FBQyxDQUFDO1FBQ0gsU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3ZDO0lBRUQsNEVBQTRFO0lBQzVFLDBDQUEwQztJQUMxQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBRSxTQUFTLENBQUUsRUFBRSxDQUFDLENBQUM7SUFFaEYsa0JBQWtCO0lBQ2xCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUVoQywyQ0FBMkM7SUFDM0MseUNBQXlDO0lBQ3pDLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNoRCxJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsTUFBTSxDQUFDLFNBQVMsZ0JBQWdCLE1BQU0sQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDO0tBQ3BHO0lBRUQsSUFBSSxtQ0FBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFO1FBQ3pDLHFDQUFxQztRQUNyQyxJQUFJLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDOUM7U0FBTTtRQUNMLDhCQUE4QjtRQUM5QixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNuRCxJQUFJLGlCQUFpQixDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDaEQ7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuaW1wb3J0ICdzb3VyY2UtbWFwLXN1cHBvcnQvcmVnaXN0ZXInO1xuXG5pbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY2RrJyk7XG5pbXBvcnQgY2hpbGRfcHJvY2VzcyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgWUFNTCA9IHJlcXVpcmUoJ3lhbWwnKTtcblxuaW1wb3J0IHsgaXNTdGFja0NvbnN0cnVjdG9yLCBwYXJzZUFwcGxldCB9IGZyb20gJy4uL2xpYi9hcHBsZXQtaGVscGVycyc7XG5cbm1haW4oKS5jYXRjaChlID0+IHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgY29uc29sZS5lcnJvcihlKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIG1haW4oKSB7XG4gIGNvbnN0IHByb2duYW1lID0gcGF0aC5iYXNlbmFtZShwcm9jZXNzLmFyZ3ZbMV0pO1xuXG4gIGNvbnN0IGFwcGxldEZpbGUgPSBwcm9jZXNzLmFyZ3ZbMl07XG4gIGlmICghYXBwbGV0RmlsZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVXNhZ2U6ICR7cHJvZ25hbWV9IDxhcHBsZXQueWFtbD5gKTtcbiAgfVxuXG4gIC8vIHJlYWQgYXBwbGV0KHMpIHByb3BlcnRpZXMgZnJvbSB0aGUgcHJvdmlkZWQgZmlsZVxuICBjb25zdCBmaWxlQ29udGVudHMgPSBZQU1MLnBhcnNlKGF3YWl0IGZzLnJlYWRGaWxlKGFwcGxldEZpbGUsIHsgZW5jb2Rpbmc6ICd1dGYtOCcgfSkpO1xuICBpZiAodHlwZW9mIGZpbGVDb250ZW50cyAhPT0gJ29iamVjdCcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7YXBwbGV0RmlsZX06IHNob3VsZCBjb250YWluIGEgWUFNTCBvYmplY3RgKTtcbiAgfVxuICBjb25zdCBhcHBsZXRNYXAgPSBmaWxlQ29udGVudHMuYXBwbGV0cztcbiAgaWYgKCFhcHBsZXRNYXApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7YXBwbGV0RmlsZX06IG11c3QgaGF2ZSBhbiAnYXBwbGV0cycga2V5YCk7XG4gIH1cblxuICBjb25zdCBzZWFyY2hEaXIgPSBwYXRoLmRpcm5hbWUoYXBwbGV0RmlsZSk7XG4gIGNvbnN0IHRlbXBEaXIgPSBhd2FpdCBmcy5ta2R0ZW1wKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2Nka2FwcGxldCcpKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuXG4gICAgZm9yIChjb25zdCBbbmFtZSwgZGVmaW5pdGlvbl0gb2YgT2JqZWN0LmVudHJpZXMoYXBwbGV0TWFwKSkge1xuICAgICAgYXdhaXQgY29uc3RydWN0U3RhY2soYXBwLCBzZWFyY2hEaXIsIHRlbXBEaXIsIG5hbWUsIGRlZmluaXRpb24pO1xuICAgIH1cbiAgICBhcHAucnVuKCk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHRlbXBEaXIpO1xuICB9XG59XG5cbi8qKlxuICogQ29uc3RydWN0IGEgc3RhY2sgZnJvbSB0aGUgZ2l2ZW4gcHJvcHNcbiAqIEBwYXJhbSBwcm9wcyBDb25zdFxuICovXG5hc3luYyBmdW5jdGlvbiBjb25zdHJ1Y3RTdGFjayhhcHA6IGNkay5BcHAsIHNlYXJjaERpcjogc3RyaW5nLCB0ZW1wRGlyOiBzdHJpbmcsIHN0YWNrTmFtZTogc3RyaW5nLCBzcGVjOiBhbnkpIHtcbiAgLy8gdGhlICdhcHBsZXQnIGF0dHJpYnV0ZSB0ZWxscyB1cyBob3cgdG8gbG9hZCB0aGUgYXBwbGV0LiBpbiB0aGUgamF2YXNjcmlwdCBjYXNlXG4gIC8vIGl0IHdpbGwgYmUgaW4gdGhlIGZvcm1hdCA8bW9kdWxlPjo8Y2xhc3M+IHdoZXJlIDxtb2R1bGU+IGlzIHRlY2huaWNhbGx5IHBhc3NlZCB0byBcInJlcXVpcmVcIlxuICAvLyBhbmQgPGNsYXNzPiBpcyBleHBlY3RlZCB0byBiZSBleHBvcnRlZCBmcm9tIHRoZSBtb2R1bGUuXG4gIGNvbnN0IGFwcGxldFNwZWM6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHNwZWMudHlwZTtcbiAgaWYgKCFhcHBsZXRTcGVjKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBBcHBsZXQgJHtzdGFja05hbWV9IG1pc3NpbmcgXCJ0eXBlXCIgYXR0cmlidXRlYCk7XG4gIH1cblxuICBjb25zdCBhcHBsZXQgPSBwYXJzZUFwcGxldChhcHBsZXRTcGVjKTtcblxuICBjb25zdCBwcm9wcyA9IHNwZWMucHJvcGVydGllcyB8fCB7fTtcblxuICBpZiAoYXBwbGV0Lm5wbVBhY2thZ2UpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgIGNvbnNvbGUuZXJyb3IoYEluc3RhbGxpbmcgTlBNIHBhY2thZ2UgJHthcHBsZXQubnBtUGFja2FnZX1gKTtcbiAgICAvLyBNYWdpYyBtYXJrZXIgdG8gZG93bmxvYWQgdGhpcyBwYWNrYWdlIGRpcmVjdGx5IG9mZiBvZiBOUE1cbiAgICAvLyBXZSdyZSBnb2luZyB0byBydW4gTlBNIGFzIGEgc2hlbGwgKHNpbmNlIHByb2dyYW1tYXRpYyB1c2FnZSBpcyBub3Qgc3RhYmxlXG4gICAgLy8gYnkgdGhlaXIgb3duIGFkbWlzc2lvbikgYW5kIHdlJ3JlIGluc3RhbGxpbmcgaW50byBhIHRlbXBvcmFyeSBkaXJlY3RvcnkuXG4gICAgLy8gKEluc3RhbGxpbmcgaW50byBhIHBlcm1hbmVudCBkaXJlY3RvcnkgaXMgdXNlbGVzcyBzaW5jZSBOUE0gZG9lc24ndCBkb1xuICAgIC8vIGFueSByZWFsIGNhY2hpbmcgYW55d2F5KS5cbiAgICBjaGlsZF9wcm9jZXNzLmV4ZWNGaWxlU3luYygnbnBtJywgWydpbnN0YWxsJywgJy0tcHJlZml4JywgdGVtcERpciwgJy0tZ2xvYmFsJywgYXBwbGV0Lm5wbVBhY2thZ2VdLCB7XG4gICAgICBzdGRpbzogJ2luaGVyaXQnXG4gICAgfSk7XG4gICAgc2VhcmNoRGlyID0gcGF0aC5qb2luKHRlbXBEaXIsICdsaWInKTtcbiAgfVxuXG4gIC8vIHdlIG5lZWQgdG8gcmVzb2x2ZSB0aGUgbW9kdWxlIG5hbWUgcmVsYXRpdmVseSB0byB3aGVyZSB0aGUgYXBwbGV0IGZpbGUgaXNcbiAgLy8gYW5kIG5vdCByZWxhdGl2ZSB0byB0aGlzIG1vZHVsZSBvciBjd2QuXG4gIGNvbnN0IG1vZHVsZVBhdGggPSByZXF1aXJlLnJlc29sdmUoYXBwbGV0Lm1vZHVsZU5hbWUsIHsgcGF0aHM6IFsgc2VhcmNoRGlyIF0gfSk7XG5cbiAgLy8gbG9hZCB0aGUgbW9kdWxlXG4gIGNvbnN0IHBrZyA9IHJlcXVpcmUobW9kdWxlUGF0aCk7XG5cbiAgLy8gZmluZCB0aGUgYXBwbGV0IGNsYXNzIHdpdGhpbiB0aGUgcGFja2FnZVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZVxuICBjb25zdCBhcHBsZXRDb25zdHJ1Y3RvciA9IHBrZ1thcHBsZXQuY2xhc3NOYW1lXTtcbiAgaWYgKCFhcHBsZXRDb25zdHJ1Y3Rvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbmQgYXBwbGV0IGNsYXNzIFwiJHthcHBsZXQuY2xhc3NOYW1lfVwiIGluIG1vZHVsZSBcIiR7YXBwbGV0Lm1vZHVsZU5hbWV9XCJgKTtcbiAgfVxuXG4gIGlmIChpc1N0YWNrQ29uc3RydWN0b3IoYXBwbGV0Q29uc3RydWN0b3IpKSB7XG4gICAgLy8gYWRkIHRoZSBhcHBsZXQgc3RhY2sgaW50byB0aGUgYXBwLlxuICAgIG5ldyBhcHBsZXRDb25zdHJ1Y3RvcihhcHAsIHN0YWNrTmFtZSwgcHJvcHMpO1xuICB9IGVsc2Uge1xuICAgIC8vIE1ha2UgYSBzdGFjayBUSEVOIGFkZCBpdCBpblxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHAsIHN0YWNrTmFtZSwgcHJvcHMpO1xuICAgIG5ldyBhcHBsZXRDb25zdHJ1Y3RvcihzdGFjaywgJ0RlZmF1bHQnLCBwcm9wcyk7XG4gIH1cbn1cbiJdfQ==