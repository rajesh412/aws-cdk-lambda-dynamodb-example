"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schema = require("../lib/schema");
function validateSpecification(test, specification) {
    validateResourceTypes(test, specification);
    validatePropertyTypes(test, specification);
}
exports.validateSpecification = validateSpecification;
function validateResourceTypes(test, specification) {
    for (const typeName of Object.keys(specification.ResourceTypes)) {
        test.ok(typeName, 'Resource type name is not empty');
        const type = specification.ResourceTypes[typeName];
        test.notEqual(type.Documentation, null, `${typeName} is documented`);
        if (type.ScrutinyType) {
            test.ok(schema.isResourceScrutinyType(type.ScrutinyType), `${typeName}.ScrutinyType is not a valid ResourceScrutinyType`);
        }
        if (type.Properties) {
            validateProperties(typeName, test, type.Properties, specification);
        }
        if (type.Attributes) {
            validateAttributes(typeName, test, type.Attributes, specification);
        }
    }
}
function validatePropertyTypes(test, specification) {
    for (const typeName of Object.keys(specification.PropertyTypes)) {
        test.ok(typeName, 'Property type name is not empty');
        const type = specification.PropertyTypes[typeName];
        test.ok(type.Documentation, `${typeName} is documented`);
        validateProperties(typeName, test, type.Properties, specification);
    }
}
function validateProperties(typeName, test, properties, specification) {
    const expectedKeys = ['Documentation', 'Required', 'UpdateType', 'ScrutinyType'];
    for (const name of Object.keys(properties)) {
        const property = properties[name];
        test.notEqual(property.Documentation, '', `${typeName}.Properties.${name} is documented`);
        test.ok(schema.isUpdateType(property.UpdateType), `${typeName}.Properties.${name} has valid UpdateType`);
        if (property.ScrutinyType !== undefined) {
            test.ok(schema.isPropertyScrutinyType(property.ScrutinyType), `${typeName}.Properties.${name} has valid ScrutinyType`);
        }
        test.notEqual(property.Required, null, `${typeName}.Properties.${name} has required flag`);
        if (schema.isPrimitiveProperty(property)) {
            test.ok(schema.isPrimitiveType(property.PrimitiveType), `${typeName}.Properties.${name} has a valid PrimitiveType`);
            expectedKeys.push('PrimitiveType');
        }
        else if (schema.isPrimitiveListProperty(property)) {
            expectedKeys.push('Type', 'DuplicatesAllowed', 'PrimitiveItemType');
            test.ok(schema.isPrimitiveType(property.PrimitiveItemType), `${typeName}.Properties.${name} has a valid PrimitiveItemType`);
        }
        else if (schema.isPrimitiveMapProperty(property)) {
            expectedKeys.push('Type', 'DuplicatesAllowed', 'PrimitiveItemType', 'Type');
            test.ok(schema.isPrimitiveType(property.PrimitiveItemType), `${typeName}.Properties.${name} has a valid PrimitiveItemType`);
            test.ok(!property.DuplicatesAllowed, `${typeName}.Properties.${name} does not allow duplicates`);
        }
        else if (schema.isComplexListProperty(property)) {
            expectedKeys.push('Type', 'DuplicatesAllowed', 'ItemType', 'Type');
            test.ok(property.ItemType, `${typeName}.Properties.${name} has a valid ItemType`);
            if (property.ItemType !== 'Tag') {
                const fqn = `${typeName.split('.')[0]}.${property.ItemType}`;
                const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                test.ok(resolvedType, `${typeName}.Properties.${name} ItemType (${fqn}) resolves`);
            }
        }
        else if (schema.isComplexMapProperty(property)) {
            expectedKeys.push('Type', 'DuplicatesAllowed', 'ItemType', 'Type');
            test.ok(property.ItemType, `${typeName}.Properties.${name} has a valid ItemType`);
            const fqn = `${typeName.split('.')[0]}.${property.ItemType}`;
            const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
            test.ok(resolvedType, `${typeName}.Properties.${name} ItemType (${fqn}) resolves`);
            test.ok(!property.DuplicatesAllowed, `${typeName}.Properties.${name} does not allow duplicates`);
        }
        else if (schema.isComplexProperty(property)) {
            expectedKeys.push('Type');
            test.ok(property.Type, `${typeName}.Properties.${name} has a valid type`);
            const fqn = `${typeName.split('.')[0]}.${property.Type}`;
            const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
            test.ok(resolvedType, `${typeName}.Properties.${name} type (${fqn}) resolves`);
        }
        else if (schema.isUnionProperty(property)) {
            expectedKeys.push('PrimitiveTypes', 'PrimitiveItemTypes', 'ItemTypes', 'Types');
            if (property.PrimitiveTypes) {
                for (const type of property.PrimitiveTypes) {
                    test.ok(schema.isPrimitiveType(type), `${typeName}.Properties.${name} has only valid PrimitiveTypes`);
                }
            }
            if (property.ItemTypes) {
                for (const type of property.ItemTypes) {
                    const fqn = `${typeName.split('.')[0]}.${type}`;
                    const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                    test.ok(resolvedType, `${typeName}.Properties.${name} type (${fqn}) resolves`);
                }
            }
            if (property.Types) {
                for (const type of property.Types) {
                    const fqn = `${typeName.split('.')[0]}.${type}`;
                    const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
                    test.ok(resolvedType, `${typeName}.Properties.${name} type (${fqn}) resolves`);
                }
            }
        }
        else {
            test.ok(false, `${typeName}.Properties.${name} has known type`);
        }
        test.deepEqual(without(Object.keys(property), expectedKeys), [], `${typeName}.Properties.${name} has no extra properties`);
    }
}
function validateAttributes(typeName, test, attributes, specification) {
    for (const name of Object.keys(attributes)) {
        const attribute = attributes[name];
        test.ok(('Type' in attribute) !== ('PrimitiveType' in attribute));
        if (schema.isPrimitiveAttribute(attribute)) {
            test.ok(!schema.isListAttribute(attribute), `${typeName}.Attributes.${name} is only a Primitive type`);
            test.ok(schema.isPrimitiveType(attribute.PrimitiveType), `${typeName}.Attributes.${name} has a valid PrimitiveType`);
            test.ok(!('PrimitiveItemType' in attribute), `${typeName}.Attributes.${name} has no PrimitiveItemType`);
            test.ok(!('ItemType' in attribute), `${typeName}.Attributes.${name} has no ItemType`);
        }
        else if (schema.isPrimitiveListAttribute(attribute)) {
            test.ok(!schema.isComplexListAttribute(attribute), `${typeName}.Attributes.${name} is only a List<Primitive> type`);
            test.ok(schema.isPrimitiveType(attribute.PrimitiveItemType), `${typeName}.Attributes.${name} has a valid PrimitiveItemType`);
            test.ok(!('ItemType' in attribute), `${typeName}.Attributes.${name} has no ItemType`);
        }
        else if (schema.isComplexListAttribute(attribute)) {
            test.ok(attribute.ItemType, `${typeName}.Attributes.${name} is a valid List<Complex> type`);
            const fqn = `${typeName.split('.')[0]}.${attribute.ItemType}`;
            const resolvedType = specification.PropertyTypes && specification.PropertyTypes[fqn];
            test.ok(resolvedType, `${typeName}.Attributes.${name} ItemType (${fqn}) resolves`);
            test.ok(!('PrimitiveItemType' in attribute), `${typeName}.Attributes.${name} has no PrimitiveItemType`);
        }
        else {
            test.ok(false, `${typeName}.Attributes.${name} has a valid type`);
        }
    }
}
/**
 * Remove elements from a set
 */
function without(xs, ...sets) {
    const ret = new Set(xs);
    for (const set of sets) {
        for (const element of set) {
            if (ret.has(element)) {
                ret.delete(element);
            }
        }
    }
    return Array.from(ret);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlYy12YWxpZGF0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3BlYy12YWxpZGF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esd0NBQXlDO0FBR3pDLFNBQWdCLHFCQUFxQixDQUFDLElBQVUsRUFBRSxhQUE0QjtJQUM1RSxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDM0MscUJBQXFCLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFIRCxzREFHQztBQUVELFNBQVMscUJBQXFCLENBQUMsSUFBVSxFQUFFLGFBQTRCO0lBQ3JFLEtBQUssTUFBTSxRQUFRLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLEVBQUU7UUFDL0QsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsaUNBQWlDLENBQUMsQ0FBQztRQUNyRCxNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsR0FBRyxRQUFRLGdCQUFnQixDQUFDLENBQUM7UUFDckUsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxHQUFHLFFBQVEsbURBQW1ELENBQUMsQ0FBQztTQUMzSDtRQUNELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUFFLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztTQUFFO1FBQzVGLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUFFLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFVB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QUNILFNBQVMsT0FBTyxDQUFJLEVBQU8sRUFBRSxHQUFHLElBQVc7SUFDekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFeEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLEVBQUU7UUFDdEIsS0FBSyxNQUFNLE9BQU8sSUFBSSxHQUFHLEVBQUU7WUFDekIsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNwQixHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3JCO1NBQ0Y7S0FDRjtJQUVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN6QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCBzY2hlbWEgPSByZXF1aXJlKCcuLi9saWIvc2NoZW1hJyk7XG5pbXBvcnQgeyBTcGVjaWZpY2F0aW9uIH0gZnJvbSAnLi4vbGliL3NjaGVtYSc7XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVNwZWNpZmljYXRpb24odGVzdDogVGVzdCwgc3BlY2lmaWNhdGlvbjogU3BlY2lmaWNhdGlvbikge1xuICB2YWxpZGF0ZVJlc291cmNlVHlwZXModGVzdCwgc3BlY2lmaWNhdGlvbik7XG4gIHZhbGlkYXRlUHJvcGVydHlUeXBlcyh0ZXN0LCBzcGVjaWZpY2F0aW9uKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVSZXNvdXJjZVR5cGVzKHRlc3Q6IFRlc3QsIHNwZWNpZmljYXRpb246IFNwZWNpZmljYXRpb24pIHtcbiAgZm9yIChjb25zdCB0eXBlTmFtZSBvZiBPYmplY3Qua2V5cyhzcGVjaWZpY2F0aW9uLlJlc291cmNlVHlwZXMpKSB7XG4gICAgdGVzdC5vayh0eXBlTmFtZSwgJ1Jlc291cmNlIHR5cGUgbmFtZSBpcyBub3QgZW1wdHknKTtcbiAgICBjb25zdCB0eXBlID0gc3BlY2lmaWNhdGlvbi5SZXNvdXJjZVR5cGVzW3R5cGVOYW1lXTtcbiAgICB0ZXN0Lm5vdEVxdWFsKHR5cGUuRG9jdW1lbnRhdGlvbiwgbnVsbCwgYCR7dHlwZU5hbWV9IGlzIGRvY3VtZW50ZWRgKTtcbiAgICBpZiAodHlwZS5TY3J1dGlueVR5cGUpIHtcbiAgICAgIHRlc3Qub2soc2NoZW1hLmlzUmVzb3VyY2VTY3J1dGlueVR5cGUodHlwZS5TY3J1dGlueVR5cGUpLCBgJHt0eXBlTmFtZX0uU2NydXRpbnlUeXBlIGlzIG5vdCBhIHZhbGlkIFJlc291cmNlU2NydXRpbnlUeXBlYCk7XG4gICAgfVxuICAgIGlmICh0eXBlLlByb3BlcnRpZXMpIHsgdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGVOYW1lLCB0ZXN0LCB0eXBlLlByb3BlcnRpZXMsIHNwZWNpZmljYXRpb24pOyB9XG4gICAgaWYgKHR5cGUuQXR0cmlidXRlcykgeyB2YWxpZGF0ZUF0dHJpYnV0ZXModHlwZU5hbWUsIHRlc3QsIHR5cGUuQXR0cmlidXRlcywgc3BlY2lmaWNhdGlvbik7IH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnR5VHlwZXModGVzdDogVGVzdCwgc3BlY2lmaWNhdGlvbjogU3BlY2lmaWNhdGlvbikge1xuICBmb3IgKGNvbnN0IHR5cGVOYW1lIG9mIE9iamVjdC5rZXlzKHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcykpIHtcbiAgICB0ZXN0Lm9rKHR5cGVOYW1lLCAnUHJvcGVydHkgdHlwZSBuYW1lIGlzIG5vdCBlbXB0eScpO1xuICAgIGNvbnN0IHR5cGUgPSBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXNbdHlwZU5hbWVdO1xuICAgIHRlc3Qub2sodHlwZS5Eb2N1bWVudGF0aW9uLCBgJHt0eXBlTmFtZX0gaXMgZG9jdW1lbnRlZGApO1xuICAgIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlTmFtZSwgdGVzdCwgdHlwZS5Qcm9wZXJ0aWVzLCBzcGVjaWZpY2F0aW9uKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXModHlwZU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0OiBUZXN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHsgW25hbWU6IHN0cmluZ106IHNjaGVtYS5Qcm9wZXJ0eSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZmljYXRpb246IFNwZWNpZmljYXRpb24pIHtcbiAgY29uc3QgZXhwZWN0ZWRLZXlzID0gWydEb2N1bWVudGF0aW9uJywgJ1JlcXVpcmVkJywgJ1VwZGF0ZVR5cGUnLCAnU2NydXRpbnlUeXBlJ107XG4gIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSkge1xuXG4gICAgY29uc3QgcHJvcGVydHkgPSBwcm9wZXJ0aWVzW25hbWVdO1xuICAgIHRlc3Qubm90RXF1YWwocHJvcGVydHkuRG9jdW1lbnRhdGlvbiwgJycsIGAke3R5cGVOYW1lfS5Qcm9wZXJ0aWVzLiR7bmFtZX0gaXMgZG9jdW1lbnRlZGApO1xuICAgIHRlc3Qub2soc2NoZW1hLmlzVXBkYXRlVHlwZShwcm9wZXJ0eS5VcGRhdGVUeXBlKSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMgdmFsaWQgVXBkYXRlVHlwZWApO1xuICAgIGlmIChwcm9wZXJ0eS5TY3J1dGlueVR5cGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGVzdC5vayhzY2hlbWEuaXNQcm9wZXJ0eVNjcnV0aW55VHlwZShwcm9wZXJ0eS5TY3J1dGlueVR5cGUpLCBgJHt0eXBlTmFtZX0uUHJvcGVydGllcy4ke25hbWV9IGhhcyB2YWxpZCBTY3J1dGlueVR5cGVgKTtcbiAgICB9XG4gICAgdGVzdC5ub3RFcXVhbChwcm9wZXJ0eS5SZXF1aXJlZCwgbnVsbCwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMgcmVxdWlyZWQgZmxhZ2ApO1xuXG4gICAgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZVByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgdGVzdC5vayhzY2hlbWEuaXNQcmltaXRpdmVUeXBlKHByb3BlcnR5LlByaW1pdGl2ZVR5cGUpLCBgJHt0eXBlTmFtZX0uUHJvcGVydGllcy4ke25hbWV9IGhhcyBhIHZhbGlkIFByaW1pdGl2ZVR5cGVgKTtcbiAgICAgIGV4cGVjdGVkS2V5cy5wdXNoKCdQcmltaXRpdmVUeXBlJyk7XG5cbiAgICB9IGVsc2UgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZUxpc3RQcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgIGV4cGVjdGVkS2V5cy5wdXNoKCdUeXBlJywgJ0R1cGxpY2F0ZXNBbGxvd2VkJywgJ1ByaW1pdGl2ZUl0ZW1UeXBlJyk7XG4gICAgICB0ZXN0Lm9rKHNjaGVtYS5pc1ByaW1pdGl2ZVR5cGUocHJvcGVydHkuUHJpbWl0aXZlSXRlbVR5cGUpLCBgJHt0eXBlTmFtZX0uUHJvcGVydGllcy4ke25hbWV9IGhhcyBhIHZhbGlkIFByaW1pdGl2ZUl0ZW1UeXBlYCk7XG5cbiAgICB9IGVsc2UgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZU1hcFByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgZXhwZWN0ZWRLZXlzLnB1c2goJ1R5cGUnLCAnRHVwbGljYXRlc0FsbG93ZWQnLCAnUHJpbWl0aXZlSXRlbVR5cGUnLCAnVHlwZScpO1xuICAgICAgdGVzdC5vayhzY2hlbWEuaXNQcmltaXRpdmVUeXBlKHByb3BlcnR5LlByaW1pdGl2ZUl0ZW1UeXBlKSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMgYSB2YWxpZCBQcmltaXRpdmVJdGVtVHlwZWApO1xuICAgICAgdGVzdC5vayghcHJvcGVydHkuRHVwbGljYXRlc0FsbG93ZWQsIGAke3R5cGVOYW1lfS5Qcm9wZXJ0aWVzLiR7bmFtZX0gZG9lcyBub3QgYWxsb3cgZHVwbGljYXRlc2ApO1xuXG4gICAgfSBlbHNlIGlmIChzY2hlbWEuaXNDb21wbGV4TGlzdFByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgZXhwZWN0ZWRLZXlzLnB1c2goJ1R5cGUnLCAnRHVwbGljYXRlc0FsbG93ZWQnLCAnSXRlbVR5cGUnLCAnVHlwZScpO1xuICAgICAgdGVzdC5vayhwcm9wZXJ0eS5JdGVtVHlwZSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMgYSB2YWxpZCBJdGVtVHlwZWApO1xuICAgICAgaWYgKHByb3BlcnR5Lkl0ZW1UeXBlICE9PSAnVGFnJykge1xuICAgICAgICBjb25zdCBmcW4gPSBgJHt0eXBlTmFtZS5zcGxpdCgnLicpWzBdfS4ke3Byb3BlcnR5Lkl0ZW1UeXBlfWA7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkVHlwZSA9IHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcyAmJiBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXNbZnFuXTtcbiAgICAgICAgdGVzdC5vayhyZXNvbHZlZFR5cGUsIGAke3R5cGVOYW1lfS5Qcm9wZXJ0aWVzLiR7bmFtZX0gSXRlbVR5cGUgKCR7ZnFufSkgcmVzb2x2ZXNgKTtcbiAgICAgIH1cblxuICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzQ29tcGxleE1hcFByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgZXhwZWN0ZWRLZXlzLnB1c2goJ1R5cGUnLCAnRHVwbGljYXRlc0FsbG93ZWQnLCAnSXRlbVR5cGUnLCAnVHlwZScpO1xuICAgICAgdGVzdC5vayhwcm9wZXJ0eS5JdGVtVHlwZSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMgYSB2YWxpZCBJdGVtVHlwZWApO1xuICAgICAgY29uc3QgZnFuID0gYCR7dHlwZU5hbWUuc3BsaXQoJy4nKVswXX0uJHtwcm9wZXJ0eS5JdGVtVHlwZX1gO1xuICAgICAgY29uc3QgcmVzb2x2ZWRUeXBlID0gc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzICYmIHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlc1tmcW5dO1xuICAgICAgdGVzdC5vayhyZXNvbHZlZFR5cGUsIGAke3R5cGVOYW1lfS5Qcm9wZXJ0aWVzLiR7bmFtZX0gSXRlbVR5cGUgKCR7ZnFufSkgcmVzb2x2ZXNgKTtcbiAgICAgIHRlc3Qub2soIXByb3BlcnR5LkR1cGxpY2F0ZXNBbGxvd2VkLCBgJHt0eXBlTmFtZX0uUHJvcGVydGllcy4ke25hbWV9IGRvZXMgbm90IGFsbG93IGR1cGxpY2F0ZXNgKTtcblxuICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzQ29tcGxleFByb3BlcnR5KHByb3BlcnR5KSkge1xuICAgICAgZXhwZWN0ZWRLZXlzLnB1c2goJ1R5cGUnKTtcbiAgICAgIHRlc3Qub2socHJvcGVydHkuVHlwZSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMgYSB2YWxpZCB0eXBlYCk7XG4gICAgICBjb25zdCBmcW4gPSBgJHt0eXBlTmFtZS5zcGxpdCgnLicpWzBdfS4ke3Byb3BlcnR5LlR5cGV9YDtcbiAgICAgIGNvbnN0IHJlc29sdmVkVHlwZSA9IHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcyAmJiBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXNbZnFuXTtcbiAgICAgIHRlc3Qub2socmVzb2x2ZWRUeXBlLCBgJHt0eXBlTmFtZX0uUHJvcGVydGllcy4ke25hbWV9IHR5cGUgKCR7ZnFufSkgcmVzb2x2ZXNgKTtcblxuICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzVW5pb25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHtcbiAgICAgIGV4cGVjdGVkS2V5cy5wdXNoKCdQcmltaXRpdmVUeXBlcycsICdQcmltaXRpdmVJdGVtVHlwZXMnLCAnSXRlbVR5cGVzJywgJ1R5cGVzJyk7XG4gICAgICBpZiAocHJvcGVydHkuUHJpbWl0aXZlVHlwZXMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIHByb3BlcnR5LlByaW1pdGl2ZVR5cGVzKSB7XG4gICAgICAgICAgdGVzdC5vayhzY2hlbWEuaXNQcmltaXRpdmVUeXBlKHR5cGUpLCBgJHt0eXBlTmFtZX0uUHJvcGVydGllcy4ke25hbWV9IGhhcyBvbmx5IHZhbGlkIFByaW1pdGl2ZVR5cGVzYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcm9wZXJ0eS5JdGVtVHlwZXMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIHByb3BlcnR5Lkl0ZW1UeXBlcykge1xuICAgICAgICAgIGNvbnN0IGZxbiA9IGAke3R5cGVOYW1lLnNwbGl0KCcuJylbMF19LiR7dHlwZX1gO1xuICAgICAgICAgIGNvbnN0IHJlc29sdmVkVHlwZSA9IHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcyAmJiBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXNbZnFuXTtcbiAgICAgICAgICB0ZXN0Lm9rKHJlc29sdmVkVHlwZSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSB0eXBlICgke2Zxbn0pIHJlc29sdmVzYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcm9wZXJ0eS5UeXBlcykge1xuICAgICAgICBmb3IgKGNvbnN0IHR5cGUgb2YgcHJvcGVydHkuVHlwZXMpIHtcbiAgICAgICAgICBjb25zdCBmcW4gPSBgJHt0eXBlTmFtZS5zcGxpdCgnLicpWzBdfS4ke3R5cGV9YDtcbiAgICAgICAgICBjb25zdCByZXNvbHZlZFR5cGUgPSBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXMgJiYgc3BlY2lmaWNhdGlvbi5Qcm9wZXJ0eVR5cGVzW2Zxbl07XG4gICAgICAgICAgdGVzdC5vayhyZXNvbHZlZFR5cGUsIGAke3R5cGVOYW1lfS5Qcm9wZXJ0aWVzLiR7bmFtZX0gdHlwZSAoJHtmcW59KSByZXNvbHZlc2ApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICB9IGVsc2Uge1xuICAgICAgdGVzdC5vayhmYWxzZSwgYCR7dHlwZU5hbWV9LlByb3BlcnRpZXMuJHtuYW1lfSBoYXMga25vd24gdHlwZWApO1xuICAgIH1cblxuICAgIHRlc3QuZGVlcEVxdWFsKFxuICAgICAgICB3aXRob3V0KE9iamVjdC5rZXlzKHByb3BlcnR5KSwgZXhwZWN0ZWRLZXlzKSwgW10sXG4gICAgICAgIGAke3R5cGVOYW1lfS5Qcm9wZXJ0aWVzLiR7bmFtZX0gaGFzIG5vIGV4dHJhIHByb3BlcnRpZXNgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUF0dHJpYnV0ZXModHlwZU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0OiBUZXN0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHsgW25hbWU6IHN0cmluZ106IHNjaGVtYS5BdHRyaWJ1dGUgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZpY2F0aW9uOiBTcGVjaWZpY2F0aW9uKSB7XG4gIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKSkge1xuICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbbmFtZV07XG4gICAgdGVzdC5vaygoJ1R5cGUnIGluIGF0dHJpYnV0ZSkgIT09ICgnUHJpbWl0aXZlVHlwZScgaW4gYXR0cmlidXRlKSk7XG4gICAgaWYgKHNjaGVtYS5pc1ByaW1pdGl2ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpKSB7XG4gICAgICB0ZXN0Lm9rKCFzY2hlbWEuaXNMaXN0QXR0cmlidXRlKGF0dHJpYnV0ZSksIGAke3R5cGVOYW1lfS5BdHRyaWJ1dGVzLiR7bmFtZX0gaXMgb25seSBhIFByaW1pdGl2ZSB0eXBlYCk7XG4gICAgICB0ZXN0Lm9rKHNjaGVtYS5pc1ByaW1pdGl2ZVR5cGUoYXR0cmlidXRlLlByaW1pdGl2ZVR5cGUpLCBgJHt0eXBlTmFtZX0uQXR0cmlidXRlcy4ke25hbWV9IGhhcyBhIHZhbGlkIFByaW1pdGl2ZVR5cGVgKTtcbiAgICAgIHRlc3Qub2soISgnUHJpbWl0aXZlSXRlbVR5cGUnIGluIGF0dHJpYnV0ZSksIGAke3R5cGVOYW1lfS5BdHRyaWJ1dGVzLiR7bmFtZX0gaGFzIG5vIFByaW1pdGl2ZUl0ZW1UeXBlYCk7XG4gICAgICB0ZXN0Lm9rKCEoJ0l0ZW1UeXBlJyBpbiBhdHRyaWJ1dGUpLCBgJHt0eXBlTmFtZX0uQXR0cmlidXRlcy4ke25hbWV9IGhhcyBubyBJdGVtVHlwZWApO1xuICAgIH0gZWxzZSBpZiAoc2NoZW1hLmlzUHJpbWl0aXZlTGlzdEF0dHJpYnV0ZShhdHRyaWJ1dGUpKSB7XG4gICAgICB0ZXN0Lm9rKCFzY2hlbWEuaXNDb21wbGV4TGlzdEF0dHJpYnV0ZShhdHRyaWJ1dGUpLCBgJHt0eXBlTmFtZX0uQXR0cmlidXRlcy4ke25hbWV9IGlzIG9ubHkgYSBMaXN0PFByaW1pdGl2ZT4gdHlwZWApO1xuICAgICAgdGVzdC5vayhzY2hlbWEuaXNQcmltaXRpdmVUeXBlKGF0dHJpYnV0ZS5QcmltaXRpdmVJdGVtVHlwZSksIGAke3R5cGVOYW1lfS5BdHRyaWJ1dGVzLiR7bmFtZX0gaGFzIGEgdmFsaWQgUHJpbWl0aXZlSXRlbVR5cGVgKTtcbiAgICAgIHRlc3Qub2soISgnSXRlbVR5cGUnIGluIGF0dHJpYnV0ZSksIGAke3R5cGVOYW1lfS5BdHRyaWJ1dGVzLiR7bmFtZX0gaGFzIG5vIEl0ZW1UeXBlYCk7XG4gICAgfSBlbHNlIGlmIChzY2hlbWEuaXNDb21wbGV4TGlzdEF0dHJpYnV0ZShhdHRyaWJ1dGUpKSB7XG4gICAgICB0ZXN0Lm9rKGF0dHJpYnV0ZS5JdGVtVHlwZSwgYCR7dHlwZU5hbWV9LkF0dHJpYnV0ZXMuJHtuYW1lfSBpcyBhIHZhbGlkIExpc3Q8Q29tcGxleD4gdHlwZWApO1xuICAgICAgY29uc3QgZnFuID0gYCR7dHlwZU5hbWUuc3BsaXQoJy4nKVswXX0uJHthdHRyaWJ1dGUuSXRlbVR5cGV9YDtcbiAgICAgIGNvbnN0IHJlc29sdmVkVHlwZSA9IHNwZWNpZmljYXRpb24uUHJvcGVydHlUeXBlcyAmJiBzcGVjaWZpY2F0aW9uLlByb3BlcnR5VHlwZXNbZnFuXTtcbiAgICAgIHRlc3Qub2socmVzb2x2ZWRUeXBlLCBgJHt0eXBlTmFtZX0uQXR0cmlidXRlcy4ke25hbWV9IEl0ZW1UeXBlICgke2Zxbn0pIHJlc29sdmVzYCk7XG4gICAgICB0ZXN0Lm9rKCEoJ1ByaW1pdGl2ZUl0ZW1UeXBlJyBpbiBhdHRyaWJ1dGUpLCBgJHt0eXBlTmFtZX0uQXR0cmlidXRlcy4ke25hbWV9IGhhcyBubyBQcmltaXRpdmVJdGVtVHlwZWApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0ZXN0Lm9rKGZhbHNlLCBgJHt0eXBlTmFtZX0uQXR0cmlidXRlcy4ke25hbWV9IGhhcyBhIHZhbGlkIHR5cGVgKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBSZW1vdmUgZWxlbWVudHMgZnJvbSBhIHNldFxuICovXG5mdW5jdGlvbiB3aXRob3V0PFQ+KHhzOiBUW10sIC4uLnNldHM6IFRbXVtdKSB7XG4gIGNvbnN0IHJldCA9IG5ldyBTZXQoeHMpO1xuXG4gIGZvciAoY29uc3Qgc2V0IG9mIHNldHMpIHtcbiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2Ygc2V0KSB7XG4gICAgICBpZiAocmV0LmhhcyhlbGVtZW50KSkge1xuICAgICAgICByZXQuZGVsZXRlKGVsZW1lbnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBBcnJheS5mcm9tKHJldCk7XG59Il19