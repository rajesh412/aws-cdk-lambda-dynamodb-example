"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable-next-line:max-line-length
const cx_api_1 = require("@aws-cdk/cx-api");
const colors = require("colors");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const archive_1 = require("./archive");
const docker_1 = require("./docker");
const logging_1 = require("./logging");
async function prepareAssets(stack, toolkitInfo) {
    const assets = findAssets(stack.metadata);
    if (assets.length === 0) {
        return [];
    }
    if (!toolkitInfo) {
        // tslint:disable-next-line:max-line-length
        throw new Error(`This stack uses assets, so the toolkit stack must be deployed to the environment (Run "${colors.blue("cdk bootstrap " + stack.environment.name)}")`);
    }
    logging_1.debug('Preparing assets');
    let params = new Array();
    for (const asset of assets) {
        logging_1.debug(` - ${asset.path} (${asset.packaging})`);
        params = params.concat(await prepareAsset(asset, toolkitInfo));
    }
    return params;
}
exports.prepareAssets = prepareAssets;
async function prepareAsset(asset, toolkitInfo) {
    logging_1.debug('Preparing asset', JSON.stringify(asset));
    switch (asset.packaging) {
        case 'zip':
            return await prepareZipAsset(asset, toolkitInfo);
        case 'file':
            return await prepareFileAsset(asset, toolkitInfo);
        case 'container-image':
            return await docker_1.prepareContainerAsset(asset, toolkitInfo);
        default:
            // tslint:disable-next-line:max-line-length
            throw new Error(`Unsupported packaging type: ${asset.packaging}. You might need to upgrade your aws-cdk toolkit to support this asset type.`);
    }
}
async function prepareZipAsset(asset, toolkitInfo) {
    logging_1.debug('Preparing zip asset from directory:', asset.path);
    const staging = await fs.mkdtemp(path.join(os.tmpdir(), 'cdk-assets'));
    try {
        const archiveFile = path.join(staging, 'archive.zip');
        await archive_1.zipDirectory(asset.path, archiveFile);
        logging_1.debug('zip archive:', archiveFile);
        return await prepareFileAsset(asset, toolkitInfo, archiveFile, 'application/zip');
    }
    finally {
        await fs.remove(staging);
    }
}
/**
 * @param asset The asset descriptor
 * @param toolkitInfo The toolkit stack
 * @param filePath Alternative file path to use (instead of asset.path)
 * @param contentType Content-type to use when uploading to S3 (none will be specified by default)
 */
async function prepareFileAsset(asset, toolkitInfo, filePath, contentType) {
    filePath = filePath || asset.path;
    logging_1.debug('Preparing file asset:', filePath);
    const data = await fs.readFile(filePath);
    const s3KeyPrefix = `assets/${asset.id}/`;
    const { filename, key, changed } = await toolkitInfo.uploadIfChanged(data, {
        s3KeyPrefix,
        s3KeySuffix: path.extname(filePath),
        contentType
    });
    const relativePath = path.relative(process.cwd(), asset.path);
    const s3url = `s3://${toolkitInfo.bucketName}/${key}`;
    logging_1.debug(`S3 url for ${relativePath}: ${s3url}`);
    if (changed) {
        logging_1.success(`Updated: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    else {
        logging_1.debug(`Up-to-date: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    return [
        { ParameterKey: asset.s3BucketParameter, ParameterValue: toolkitInfo.bucketName },
        { ParameterKey: asset.s3KeyParameter, ParameterValue: `${s3KeyPrefix}${cx_api_1.ASSET_PREFIX_SEPARATOR}${filename}` },
    ];
}
function findAssets(metadata) {
    const assets = new Array();
    for (const k of Object.keys(metadata)) {
        for (const entry of metadata[k]) {
            if (entry.type === cx_api_1.ASSET_METADATA) {
                assets.push(entry.data);
            }
        }
    }
    return assets;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQTJDO0FBQzNDLDRDQUFzSjtBQUV0SixpQ0FBa0M7QUFDbEMsK0JBQWdDO0FBQ2hDLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFFOUIsdUNBQXlDO0FBQ3pDLHFDQUFpRDtBQUNqRCx1Q0FBMkM7QUFFcEMsS0FBSyxVQUFVLGFBQWEsQ0FBQyxLQUF1QixFQUFFLFdBQXlCO0lBQ3BGLE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDMUMsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUN2QixPQUFPLEVBQUUsQ0FBQztLQUNYO0lBRUQsSUFBSSxDQUFDLFdBQVcsRUFBRTtRQUNoQiwyQ0FBMkM7UUFDM0MsTUFBTSxJQUFJLEtBQUssQ0FBQywwRkFBMEYsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUMsV0FBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUN4SztJQUVELGVBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQzFCLElBQUksTUFBTSxHQUFHLElBQUksS0FBSyxFQUE0QixDQUFDO0lBQ25ELEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1FBQzFCLGVBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFFL0MsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxZQUFZLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUM7S0FDaEU7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBcEJELHNDQW9CQztBQUVELEtBQUssVUFBVSxZQUFZLENBQUMsS0FBeUIsRUFBRSxXQUF3QjtJQUM3RSxlQUFLLENB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LFlBQVksRUFBRSxLQUFLLENBQUMsaUJBQWlCLEVBQUUsY0FBYyxFQUFFLFdBQVcsQ0FBQyxVQUFVLEVBQUU7UUFDakYsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLGNBQWMsRUFBRSxjQUFjLEVBQUUsR0FBRyxXQUFXLEdBQUcsK0JBQXNCLEdBQUcsUUFBUSxFQUFFLEVBQUU7S0FDN0csQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxRQUF1QjtJQUN6QyxNQUFNLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBc0IsQ0FBQztJQUUvQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDckMsS0FBSyxNQUFNLEtBQUssSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDL0IsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLHVCQUFjLEVBQUU7Z0JBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3pCO1NBQ0Y7S0FDRjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG5pbXBvcnQgeyBBU1NFVF9NRVRBREFUQSwgQVNTRVRfUFJFRklYX1NFUEFSQVRPUiwgQXNzZXRNZXRhZGF0YUVudHJ5LCBGaWxlQXNzZXRNZXRhZGF0YUVudHJ5LCBTdGFja01ldGFkYXRhLCBTeW50aGVzaXplZFN0YWNrIH0gZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uIH0gZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgY29sb3JzID0gcmVxdWlyZSgnY29sb3JzJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHsgVG9vbGtpdEluZm8gfSBmcm9tICcuL2FwaS90b29sa2l0LWluZm8nO1xuaW1wb3J0IHsgemlwRGlyZWN0b3J5IH0gZnJvbSAnLi9hcmNoaXZlJztcbmltcG9ydCB7IHByZXBhcmVDb250YWluZXJBc3NldCB9IGZyb20gJy4vZG9ja2VyJztcbmltcG9ydCB7IGRlYnVnLCBzdWNjZXNzIH0gZnJvbSAnLi9sb2dnaW5nJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByZXBhcmVBc3NldHMoc3RhY2s6IFN5bnRoZXNpemVkU3RhY2ssIHRvb2xraXRJbmZvPzogVG9vbGtpdEluZm8pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcltdPiB7XG4gIGNvbnN0IGFzc2V0cyA9IGZpbmRBc3NldHMoc3RhY2subWV0YWRhdGEpO1xuICBpZiAoYXNzZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGlmICghdG9vbGtpdEluZm8pIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGlzIHN0YWNrIHVzZXMgYXNzZXRzLCBzbyB0aGUgdG9vbGtpdCBzdGFjayBtdXN0IGJlIGRlcGxveWVkIHRvIHRoZSBlbnZpcm9ubWVudCAoUnVuIFwiJHtjb2xvcnMuYmx1ZShcImNkayBib290c3RyYXAgXCIgKyBzdGFjay5lbnZpcm9ubWVudCEubmFtZSl9XCIpYCk7XG4gIH1cblxuICBkZWJ1ZygnUHJlcGFyaW5nIGFzc2V0cycpO1xuICBsZXQgcGFyYW1zID0gbmV3IEFycmF5PENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcj4oKTtcbiAgZm9yIChjb25zdCBhc3NldCBvZiBhc3NldHMpIHtcbiAgICBkZWJ1ZyhgIC0gJHthc3NldC5wYXRofSAoJHthc3NldC5wYWNrYWdpbmd9KWApO1xuXG4gICAgcGFyYW1zID0gcGFyYW1zLmNvbmNhdChhd2FpdCBwcmVwYXJlQXNzZXQoYXNzZXQsIHRvb2xraXRJbmZvKSk7XG4gIH1cblxuICByZXR1cm4gcGFyYW1zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlQXNzZXQoYXNzZXQ6IEFzc2V0TWV0YWRhdGFFbnRyeSwgdG9vbGtpdEluZm86IFRvb2xraXRJbmZvKTogUHJvbWlzZTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXJbXT4ge1xuICBkZWJ1ZygnUHJlcGFyaW5nIGFzc2V0JywgSlNPTi5zdHJpbmdpZnkoYXNzZXQpKTtcbiAgc3dpdGNoIChhc3NldC5wYWNrYWdpbmcpIHtcbiAgICBjYXNlICd6aXAnOlxuICAgICAgcmV0dXJuIGF3YWl0IHByZXBhcmVaaXBBc3NldChhc3NldCwgdG9vbGtpdEluZm8pO1xuICAgIGNhc2UgJ2ZpbGUnOlxuICAgICAgcmV0dXJuIGF3YWl0IHByZXBhcmVGaWxlQXNzZXQoYXNzZXQsIHRvb2xraXRJbmZvKTtcbiAgICBjYXNlICdjb250YWluZXItaW1hZ2UnOlxuICAgICAgcmV0dXJuIGF3YWl0IHByZXBhcmVDb250YWluZXJBc3NldChhc3NldCwgdG9vbGtpdEluZm8pO1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHBhY2thZ2luZyB0eXBlOiAkeyhhc3NldCBhcyBhbnkpLnBhY2thZ2luZ30uIFlvdSBtaWdodCBuZWVkIHRvIHVwZ3JhZGUgeW91ciBhd3MtY2RrIHRvb2xraXQgdG8gc3VwcG9ydCB0aGlzIGFzc2V0IHR5cGUuYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZVppcEFzc2V0KGFzc2V0OiBGaWxlQXNzZXRNZXRhZGF0YUVudHJ5LCB0b29sa2l0SW5mbzogVG9vbGtpdEluZm8pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcltdPiB7XG4gIGRlYnVnKCdQcmVwYXJpbmcgemlwIGFzc2V0IGZyb20gZGlyZWN0b3J5OicsIGFzc2V0LnBhdGgpO1xuICBjb25zdCBzdGFnaW5nID0gYXdhaXQgZnMubWtkdGVtcChwYXRoLmpvaW4ob3MudG1wZGlyKCksICdjZGstYXNzZXRzJykpO1xuICB0cnkge1xuICAgIGNvbnN0IGFyY2hpdmVGaWxlID0gcGF0aC5qb2luKHN0YWdpbmcsICdhcmNoaXZlLnppcCcpO1xuICAgIGF3YWl0IHppcERpcmVjdG9yeShhc3NldC5wYXRoLCBhcmNoaXZlRmlsZSk7XG4gICAgZGVidWcoJ3ppcCBhcmNoaXZlOicsIGFyY2hpdmVGaWxlKTtcbiAgICByZXR1cm4gYXdhaXQgcHJlcGFyZUZpbGVBc3NldChhc3NldCwgdG9vbGtpdEluZm8sIGFyY2hpdmVGaWxlLCAnYXBwbGljYXRpb24vemlwJyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHN0YWdpbmcpO1xuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIGFzc2V0IFRoZSBhc3NldCBkZXNjcmlwdG9yXG4gKiBAcGFyYW0gdG9vbGtpdEluZm8gVGhlIHRvb2xraXQgc3RhY2tcbiAqIEBwYXJhbSBmaWxlUGF0aCBBbHRlcm5hdGl2ZSBmaWxlIHBhdGggdG8gdXNlIChpbnN0ZWFkIG9mIGFzc2V0LnBhdGgpXG4gKiBAcGFyYW0gY29udGVudFR5cGUgQ29udGVudC10eXBlIHRvIHVzZSB3aGVuIHVwbG9hZGluZyB0byBTMyAobm9uZSB3aWxsIGJlIHNwZWNpZmllZCBieSBkZWZhdWx0KVxuICovXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlRmlsZUFzc2V0KFxuICAgIGFzc2V0OiBGaWxlQXNzZXRNZXRhZGF0YUVudHJ5LFxuICAgIHRvb2xraXRJbmZvOiBUb29sa2l0SW5mbyxcbiAgICBmaWxlUGF0aD86IHN0cmluZyxcbiAgICBjb250ZW50VHlwZT86IHN0cmluZyk6IFByb21pc2U8Q2xvdWRGb3JtYXRpb24uUGFyYW1ldGVyW10+IHtcblxuICBmaWxlUGF0aCA9IGZpbGVQYXRoIHx8IGFzc2V0LnBhdGg7XG4gIGRlYnVnKCdQcmVwYXJpbmcgZmlsZSBhc3NldDonLCBmaWxlUGF0aCk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoKTtcblxuICBjb25zdCBzM0tleVByZWZpeCA9IGBhc3NldHMvJHthc3NldC5pZH0vYDtcblxuICBjb25zdCB7IGZpbGVuYW1lLCBrZXksIGNoYW5nZWQgfSA9IGF3YWl0IHRvb2xraXRJbmZvLnVwbG9hZElmQ2hhbmdlZChkYXRhLCB7XG4gICAgczNLZXlQcmVmaXgsXG4gICAgczNLZXlTdWZmaXg6IHBhdGguZXh0bmFtZShmaWxlUGF0aCksXG4gICAgY29udGVudFR5cGVcbiAgfSk7XG5cbiAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBhc3NldC5wYXRoKTtcblxuICBjb25zdCBzM3VybCA9IGBzMzovLyR7dG9vbGtpdEluZm8uYnVja2V0TmFtZX0vJHtrZXl9YDtcbiAgZGVidWcoYFMzIHVybCBmb3IgJHtyZWxhdGl2ZVBhdGh9OiAke3MzdXJsfWApO1xuICBpZiAoY2hhbmdlZCkge1xuICAgIHN1Y2Nlc3MoYFVwZGF0ZWQ6ICR7Y29sb3JzLmJvbGQocmVsYXRpdmVQYXRoKX0gKCR7YXNzZXQucGFja2FnaW5nfSlgKTtcbiAgfSBlbHNlIHtcbiAgICBkZWJ1ZyhgVXAtdG8tZGF0ZTogJHtjb2xvcnMuYm9sZChyZWxhdGl2ZVBhdGgpfSAoJHthc3NldC5wYWNrYWdpbmd9KWApO1xuICB9XG5cbiAgcmV0dXJuIFtcbiAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuczNCdWNrZXRQYXJhbWV0ZXIsIFBhcmFtZXRlclZhbHVlOiB0b29sa2l0SW5mby5idWNrZXROYW1lIH0sXG4gICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LnMzS2V5UGFyYW1ldGVyLCBQYXJhbWV0ZXJWYWx1ZTogYCR7czNLZXlQcmVmaXh9JHtBU1NFVF9QUkVGSVhfU0VQQVJBVE9SfSR7ZmlsZW5hbWV9YCB9LFxuICBdO1xufVxuXG5mdW5jdGlvbiBmaW5kQXNzZXRzKG1ldGFkYXRhOiBTdGFja01ldGFkYXRhKTogQXNzZXRNZXRhZGF0YUVudHJ5W10ge1xuICBjb25zdCBhc3NldHMgPSBuZXcgQXJyYXk8QXNzZXRNZXRhZGF0YUVudHJ5PigpO1xuXG4gIGZvciAoY29uc3QgayBvZiBPYmplY3Qua2V5cyhtZXRhZGF0YSkpIHtcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIG1ldGFkYXRhW2tdKSB7XG4gICAgICBpZiAoZW50cnkudHlwZSA9PT0gQVNTRVRfTUVUQURBVEEpIHtcbiAgICAgICAgYXNzZXRzLnB1c2goZW50cnkuZGF0YSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFzc2V0cztcbn1cbiJdfQ==